#!/bin/bash
#===============================================================================
# PAQET MIDDLE VPS MANAGEMENT SCRIPT
# Manages the combined paqet-client + reality-ezpz Docker Compose stack
#===============================================================================

INSTALL_DIR="/opt/paqet-middle"
REALITY_DIR="/opt/reality-ezpz"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

cd "$INSTALL_DIR" 2>/dev/null || { echo -e "${RED}[ERROR]${NC} Install directory not found: $INSTALL_DIR"; exit 1; }

case "$1" in
    start)
        echo -e "${BLUE}Starting paqet middle VPS stack...${NC}"
        docker compose up -d --build
        echo -e "${GREEN}Done.${NC} Check status with: paqet-middle-ctl status"
        ;;
    stop)
        echo -e "${BLUE}Stopping paqet middle VPS stack...${NC}"
        docker compose down
        echo -e "${GREEN}Done.${NC}"
        ;;
    restart)
        echo -e "${BLUE}Restarting paqet middle VPS stack...${NC}"
        docker compose restart
        echo -e "${GREEN}Done.${NC}"
        ;;
    status)
        docker compose ps
        ;;
    logs)
        CONTAINER="${2:-}"
        if [[ -n "$CONTAINER" ]]; then
            docker compose logs -f --tail=100 "$CONTAINER"
        else
            docker compose logs -f --tail=100
        fi
        ;;
    logs-paqet)
        docker compose logs -f --tail=100 paqet-client
        ;;
    logs-reality)
        docker compose logs -f --tail=100 reality-ezpz
        ;;
    config)
        echo -e "${CYAN}═══ Paqet Client Config ═══${NC}"
        cat "$INSTALL_DIR/config.yaml"
        ;;

    # ───────────────────────────────────────────────────────────────────────
    # Reality-EZPZ User Management
    # ───────────────────────────────────────────────────────────────────────
    reality-add-user)
        USERNAME="${2:?Usage: paqet-middle-ctl reality-add-user <username>}"
        echo -e "${BLUE}Adding user: $USERNAME${NC}"
        docker exec -it reality-ezpz bash /opt/reality-ezpz/reality-ezpz.sh --add-user="$USERNAME"
        echo ""
        echo -e "${GREEN}User added.${NC} Show config with: paqet-middle-ctl reality-show-user $USERNAME"
        ;;
    reality-list-users)
        echo -e "${CYAN}═══ Reality-EZPZ Users ═══${NC}"
        docker exec -it reality-ezpz bash /opt/reality-ezpz/reality-ezpz.sh --list-users
        ;;
    reality-show-user)
        USERNAME="${2:?Usage: paqet-middle-ctl reality-show-user <username>}"
        docker exec -it reality-ezpz bash /opt/reality-ezpz/reality-ezpz.sh --show-user="$USERNAME"
        ;;
    reality-delete-user)
        USERNAME="${2:?Usage: paqet-middle-ctl reality-delete-user <username>}"
        echo -e "${YELLOW}Deleting user: $USERNAME${NC}"
        docker exec -it reality-ezpz bash /opt/reality-ezpz/reality-ezpz.sh --delete-user="$USERNAME"
        echo -e "${GREEN}User deleted.${NC}"
        ;;
    reality-menu)
        echo -e "${BLUE}Opening Reality-EZPZ TUI menu...${NC}"
        docker exec -it reality-ezpz bash /opt/reality-ezpz/reality-ezpz.sh --menu
        ;;
    reality-config)
        echo -e "${CYAN}═══ Reality-EZPZ Server Config ═══${NC}"
        docker exec -it reality-ezpz bash /opt/reality-ezpz/reality-ezpz.sh --show-server-config
        ;;

    # ───────────────────────────────────────────────────────────────────────
    # Info & Update
    # ───────────────────────────────────────────────────────────────────────
    info)
        if [[ -f "$INSTALL_DIR/connection-info.txt" ]]; then
            cat "$INSTALL_DIR/connection-info.txt"
        else
            echo -e "${YELLOW}No connection info file found.${NC}"
        fi
        ;;
    update)
        echo -e "${BLUE}Updating paqet middle VPS stack...${NC}"
        docker compose down
        docker compose build --no-cache
        docker compose up -d
        echo -e "${GREEN}Done.${NC}"
        ;;
    uninstall)
        echo -e "${YELLOW}Uninstalling paqet middle VPS stack...${NC}"
        docker compose down -v
        docker rmi paqet-middle-paqet-client 2>/dev/null || true
        echo -e "${GREEN}Docker containers removed.${NC}"
        echo "To completely remove, run: rm -rf $INSTALL_DIR"
        echo "To also remove reality-ezpz data: rm -rf $REALITY_DIR"
        ;;
    *)
        echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${CYAN}║${NC}          Paqet Middle VPS Management (paqet + reality)          ${CYAN}║${NC}"
        echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════════╝${NC}"
        echo ""
        echo -e "${YELLOW}Usage:${NC} paqet-middle-ctl <command>"
        echo ""
        echo -e "${CYAN}── Stack Management ──────────────────────────────────────────────${NC}"
        echo "  start             Start the full stack"
        echo "  stop              Stop the full stack"
        echo "  restart           Restart all services"
        echo "  status            Show service status"
        echo "  logs [service]    Show logs (optionally for one service)"
        echo "  logs-paqet        Show paqet client logs"
        echo "  logs-reality      Show reality-ezpz logs"
        echo "  config            Show paqet client configuration"
        echo ""
        echo -e "${CYAN}── Reality-EZPZ User Management ──────────────────────────────────${NC}"
        echo "  reality-add-user <name>     Add a VLESS user"
        echo "  reality-list-users          List all VLESS users"
        echo "  reality-show-user <name>    Show user config & QR code"
        echo "  reality-delete-user <name>  Delete a user"
        echo "  reality-menu                Open TUI management menu"
        echo "  reality-config              Show reality server config"
        echo ""
        echo -e "${CYAN}── Maintenance ───────────────────────────────────────────────────${NC}"
        echo "  info              Show connection information"
        echo "  update            Rebuild and restart all services"
        echo "  uninstall         Remove all containers"
        echo ""
        ;;
esac
